# 对不同操作系统平台的兼容性处理

os_platform 中包含了针对POSIX系统和WIN系统中路径、符号链接、换行符和文件权限这种不能直接互相兼容的属性的处理方法。

## os_tar 的行为

os_tar是主要处理这种兼容性的核心工具。os_tar的主要流程如下：
- 解包：
注意这个解包是需要解到一个空文件夹的。我们不支持硬覆盖。
  1. 将tar包解压到目标文件夹，尽可能保留所有参数。
  2. 在解压中，每解压一个文件就做一次检测，如果是符号链接并且是相对路径，则转换其路径为对应os的风格。
  3. 解压完成，递归的遍历文件夹，将换行符修改为对应平台的标准换行符。 
- 打包：
  1. 将文件夹中的内容拷贝到临时目录
  2. 递归的遍历文件夹，将换行符修改为对应平台的标准换行符。 
  3. 将临时目录中的内容打包成tar包，尽可能保留所有参数。
  4. 在打包中，每打包一个文件就做一次检测，如果是符号链接并且是相对路径，则转换其路径为POSIX的风格。

## 所有者、权限、换行符和符号链接的处理

### 打包时
os_tar的行为与tar的行为一致，在打包时会尽量严格保留所有者、权限、换行符和符号链接属性，但在Win平台上不存在所有者和权限的概念，因此在打包时会将所有者和权限设置为默认值。
其中所有者是由Python设置的默认值，权限是由os_tar设置的默认值，由 PosixTarConfig 决定，默认为 文件夹权限为 755，文件权限为 644，符号链接权限为 777。换行符会根据平台的不同进行转换，符号链接会被转换为相对路径。

由于Unix系统解包时，tar默认开启了--no-same-owner选项（但并不保留--no-same-permissions），因此在解包时会将所有者会被设置为默认值。解包时的权限就是按照文件权限来设置的，这个由我们提供。
主要是我们希望我们的打包可以被轻易的使用默认参数解包，因此我们不依赖远程使用 --no-same-permissions 选项进行解包，而是在打包时就指定了文件权限。

### 解包时
os_tar的行为在解包时与tar行为一致，在解包时会尽可能严格保留所有者、权限、换行符和符号链接属性的保留并与解包所在平台保持一致。对于存在无法转换的指向绝对路径的符号链接的包内符号链接，
os_tar会给出警告，会提取此文件但不会转换。这种文件的修复依赖于 relink 这种命令的手动修复。
